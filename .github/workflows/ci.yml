name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r llm-monitor/requirements.txt
        pip install -r gpu-exporter/requirements.txt
    
    - name: Check Python syntax
      run: |
        python -m py_compile llm-monitor/llm_monitor.py
        python -m py_compile gpu-exporter/gpu_exporter.py
        python -m py_compile run-llm-model.py
        python -m py_compile run-llm-model-gpu.py
    
    - name: Validate YAML files
      run: |
        python -c "import yaml; yaml.safe_load(open('docker-compose.yml'))"
        python -c "import yaml; yaml.safe_load(open('config/prometheus/prometheus.yml'))"
        python -c "import yaml; yaml.safe_load(open('config/loki/loki-config.yml'))"
        python -c "import yaml; yaml.safe_load(open('config/tempo/tempo-config.yml'))"
        python -c "import yaml; yaml.safe_load(open('config/promtail/promtail-config.yml'))"
        python -c "import yaml; yaml.safe_load(open('config/grafana/datasources.yml'))"
        python -c "import yaml; yaml.safe_load(open('config/grafana/dashboard-provider.yml'))"
      continue-on-error: true
    
    - name: Validate JSON files
      run: |
        python -m json.tool dashboards/llm-monitoring-green-forest.json > /dev/null
    
    - name: Check file permissions
      run: |
        chmod +x start-all.ps1 stop-all.ps1 || true

  docker:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build GPU Exporter
      run: |
        docker build -t monitorai-gpu-exporter:test ./gpu-exporter

